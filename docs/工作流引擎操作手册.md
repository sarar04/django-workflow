# 目录
<!-- MarkdownTOC -->

- 概念说明
    - State
    - Transition
    - Workflow/template
    - Subject
    - WorkflowActivity/instance
- 安装工作流
- 工作流设计器
    - 全参数方式创建
    - 上传文件方式创建工作流
    - 图形化设计方式--敬请期待
    - 分步创建

<!-- /MarkdownTOC -->

## 概念说明
如图为一个典型的线性流程示意图，以此为例说明工作流的相关概念
![Alt 图1 典型的线性流程示意图](img/图一.png)

### State
图1中的椭圆部分，即流程的步骤（或节点），属性见下表

名称              | 含义             | 类型       | 说明
------------------|------------------|------------|------
name              | 节点名称         | string     | 必填
description       | 节点描述         | string     | optional
state_type        | 节点类型         | int        | 必填,具体参见工作流设计器
workflow          | 所属流程         | int        | 必填
participants      | 节点执行人       | list       | 工作流模板选填，工作流实例在流转时必填
relation          | 执行人关系       | float      | 范围:[0, 1]当该节点为多人执行时，做出相同决定的人数达到relation设置的值时，该节点处理完成，比如2/3通过，默认值1
allow_delegation  | 是否可委托       | bool       | true: 允许委托给他人false: 不可委托，默认false
allow_state_edit  | 是否可以编辑流程 | bool       | true: 允许编辑流程 false: 不可编辑,目前尚未启用该字段,默认true
deadline_warning  | 逾期提醒         | bool       | true: 逾期提醒 false: 不提醒(尚未启用)，默认值true
callback          | 流程回调         | jsonstring | 保留字段，尚未启用
deadline          | 截止日期         | date       | optional
remark            | 备注             | jsonstring | 备注字段，用以存储与流程引擎无关的信息

### Transition
图1中的箭头部分，即标明流程流转方向，属性见下表

名称              | 含义             | 类型       | 说明
------------------|------------------|------------|------
name              | 名称             | string     | 必填
from_state        | 流转起点         | int        | 必填
to_state          | 流转终点         | int        | 必填
condition         | 流转条件         | jsonstring | optional


### Workflow/template
工作流程，图1所示的整个内容可以视为一个工作流程，工作流程是业务过程的部分或整体在计算机应用环境下的自动化，是对工作流程及其各操作步骤之间业务规则的抽象、概括描述。简而言之，由name、description、creator以及多个state和transition组成。

### Subject
流程主题对象，eg: 土方边坡开挖图纸

### WorkflowActivity/instance
工作流实例，当工作流程（workflow）与具体的主题对象（subject）关联起来，则形成一个工作流实例。
eg:  workflow（图纸报审流程）+ subject（土方边坡开挖图纸 ）=workflowactivity（土方边坡开挖图纸报审流程）

## 安装工作流
该引擎依赖于Django1.10和postgresql-9.4，必须满足此条件

软件安装
* pip install -r requirements.txt
* apt-get install -y graphviz
* apt-get install postgresql-9.4
* pip install workflow

配置
settings.py : add ```workflow``` in INSTALL_APPS
urls.py: 
```
urlpatterns = [
    ...
    url(r'^flow/', include(workflow.urls), namespace='workflow')
]
```


## 工作流设计器
在该系统中，工作流由一个起点和多个(至少一个)终点构成，基本的组成节点包括6种，如图所示![Alt 图2 工作流设计器](img/图二.png)

通过6种基本的节点，可以组合出复杂的流程以满足应用需求。
### 全参数方式创建
如图一所示的线性工作流，通过如下参数即可创建, 缺省参数都采用默认值，全参数创建模板时，如果status=1，会检查workflow是否合法，不合法的会强制将status转换为0，并返回错误原因，可修改错误后再提交                

```language：python
{
    "template": True,
    "workflow": {
        "name": "线性流程",
    },
    "states": [
        {
            "name": "填报",
            "state_type": 1
        },
        {
            "name": "初审",
            "state_type": 2
        },
        {
            "name": "复审",
            "state_type": 2
        },
        {
            "name": "终审",
            "state_type": 2
        },
        {
            "name": "结束",
            "state_type": 0
        }
    ],
    "transitions": [
        {
            "name": "通过",
            "from_state": "填报",
            "to_state": "初审",
            "condition": None
        },
        {
            "name": "通过",
            "from_state": "初审",
            "to_state": "复审",
            "condition": None
        },
        {
            "name": "通过",
            "from_state": "复审",
            "to_state": "终审",
            "condition": None  
        },
        {
            "name": "退回",
            "from_state": "初审",
            "to_state": "填报",
            "condition": None
        },
        {
            "name": "退回",
            "from_state": "复审",
            "to_state": "填报",
            "condition": None
        },
        {
            "name": "退回",
            "from_state": "终审",
            "to_state": "填报",
            "condition": None
        },
        {
            "name": "通过",
            "from_state": "终审",
            "to_state": "结束",
            "condition": None
        }
    ]
}
```

### 上传文件方式创建工作流
```[post] /flow/workflow/file/```         
上传文件要求为.py格式, 参数名为```filename```

### 图形化设计方式--敬请期待

### 分步创建
#### create workflow
```[post] /flow/workflow/```

```
{
    "name": "创建流程模板",    # 必填
    "description": "",
    "status": 0,               # 0-definition 1-active 2-retired 默认0
    "creator": None,           # object，无填None
    "token": ""                # 预留字段,填""
}
```

```[put] [patch] /flow/workflow/{pk}```
参数同post

#### create state
```[post] /flow/workflow/{pk}/state/```

```
{
    "name": "开始",           # 必填
    "description": "",
    "roles": None,            # object，无填None
    "allow_delegation": False, # 默认False
    "allow_abolish": False,    # 默认False
    "allow_state_edit": False, # 默认False
    "deadline_warning": False, # 默认False
    "remark": None,            # object，无填None  
    "relation": 1,             # 0-或 1-与 
    "state_type": 1,           # 必填 0-终点 1-起点 2-一般节点 3-选择节点 4-分流点 5-合流点
    "deadline": "2019-01-01",          # 无填None 
    "callback": None                   # object，无填None
}
```
```[put] [patch] /flow/state/{pk}```
参数同post

#### create transition
```[post] /flow/workflow/{pk}/transition/```

```
{
    "name": "通过",
    "from_state": 499,   # state id
    "to_state": 500,     # state id
    "callback": None,
    "condition": None
}
```
```[put] [patch] /flow/transition/{pk}```
参数同post

